<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#121212',
                        surface: '#1E1E1E',
                        primary: '#BB86FC',
                        secondary: '#03DAC6',
                        text: '#E0E0E0',
                        muted: '#A0A0A0',
                        danger: '#CF6679'
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #121212;
            color: #E0E0E0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevents rubber-banding on iOS */
        }
        
        /* Stepper Button Interaction */
        .stepper-btn {
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        .stepper-btn:active {
            transform: scale(0.92);
        }

        /* Safe Area for iPhone X+ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Custom Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen bg-background text-text font-sans pb-safe selection:bg-primary selection:text-black">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] pointer-events-none transition-opacity duration-300 opacity-0">
        <div class="bg-surface text-white px-6 py-3 rounded-full shadow-2xl border border-primary/20 flex items-center space-x-2">
            <span id="toast-message" class="font-medium">Notification</span>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-surface/95 backdrop-blur border-b border-neutral-800 px-4 py-3 shadow-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-extrabold tracking-tight text-white italic select-none">
                IRON<span class="text-primary">TRACK</span>
            </h1>
            
            <div class="flex space-x-3">
                <div id="profile-toggles" class="flex bg-neutral-900 rounded-lg p-1 border border-neutral-800">
                    <!-- Injected via JS -->
                </div>
                
                <button id="history-toggle" class="p-2 rounded-lg transition-colors text-neutral-400 hover:text-white active:bg-neutral-800">
                    <!-- History Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-root" class="max-w-md mx-auto w-full min-h-[calc(100vh-64px)] relative">
        <!-- Dynamic Content Injected Here -->
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const STORAGE_KEY = 'iron-track-data-v1';
        
        const WORKOUT_A = [
            "Leg Press",
            "Incline Dumbbell Press",
            "Lat Pulldown",
            "Barbell Romanian Deadlift",
            "Cable Lateral Raise",
            "Incline Dumbbell Curl",
            "Cable Face Pull"
        ];

        const WORKOUT_B = [
            "Chest-Supported Row",
            "Incline Dumbbell Press",
            "Cable Pull-Through",
            "Bulgarian Split Squat",
            "Cable Lateral Raise",
            "Overhead Cable Triceps Extension",
            "Assisted Pull-Up"
        ];

        const EXERCISE_LISTS = {
            'A': WORKOUT_A,
            'B': WORKOUT_B
        };

        // --- ICONS (SVG Strings) ---
        const ICONS = {
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            minus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`,
            copy: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`,
            chevron: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
            plusLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`
        };

        // --- STATE MANAGEMENT ---
        const initialState = {
            profile: 'A',
            currentSession: [], // Array of ActiveExercise
            history: [],        // Array of WorkoutRecord
            isHistoryView: false
        };

        let state = { ...initialState };

        // Helper: Generate UUID
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- PERSISTENCE ---
        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    // Ensure view resets to workout on reload
                    state.isHistoryView = false; 
                } catch (e) {
                    console.error("Data load error", e);
                }
            }
            render();
        }

        function saveState() {
            const { profile, currentSession, history } = state;
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ profile, currentSession, history }));
        }

        // --- LOGIC: WORKOUT ---

        // Get smart defaults from history
        function getLastUsedValues(exerciseName) {
            // Search history backwards
            for (let i = state.history.length - 1; i >= 0; i--) {
                const workout = state.history[i];
                const exercise = workout.exercises.find(e => e.name === exerciseName);
                if (exercise && exercise.sets.length > 0) {
                    const lastSet = exercise.sets[exercise.sets.length - 1];
                    return { weight: lastSet.weight, reps: lastSet.reps };
                }
            }
            return { weight: 0, reps: 8 }; // Default if never performed
        }

        function addExercise(name) {
            const defaults = getLastUsedValues(name);
            const newExercise = {
                id: uuidv4(),
                name: name,
                sets: [{
                    id: uuidv4(),
                    weight: defaults.weight,
                    reps: defaults.reps,
                    completed: false
                }]
            };
            state.currentSession.push(newExercise);
            saveState();
            render();
            
            // Scroll to bottom
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function removeExercise(id) {
            if(confirm("Remove this exercise?")) {
                state.currentSession = state.currentSession.filter(ex => ex.id !== id);
                saveState();
                render();
            }
        }

        function addSet(exerciseId) {
            const exerciseIndex = state.currentSession.findIndex(ex => ex.id === exerciseId);
            if (exerciseIndex === -1) return;

            const exercise = state.currentSession[exerciseIndex];
            const previousSet = exercise.sets[exercise.sets.length - 1];
            
            const newSet = {
                id: uuidv4(),
                weight: previousSet ? previousSet.weight : 0,
                reps: previousSet ? previousSet.reps : 0,
                completed: false
            };

            exercise.sets.push(newSet);
            saveState();
            render();
        }

        function removeSet(exerciseId, setId) {
            const exercise = state.currentSession.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            exercise.sets = exercise.sets.filter(s => s.id !== setId);
            saveState();
            render();
        }

        function updateSet(exerciseId, setId, field, value) {
            const exercise = state.currentSession.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            const set = exercise.sets.find(s => s.id === setId);
            if (!set) return;

            set[field] = value;
            saveState();
            render(); // Simple re-render. For high-perf text inputs, this is bad, but for steppers it's fine.
        }

        function toggleSetComplete(exerciseId, setId) {
            const exercise = state.currentSession.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            const set = exercise.sets.find(s => s.id === setId);
            if (!set) return;

            set.completed = !set.completed;
            saveState();
            render();
        }

        function finishWorkout() {
            if (state.currentSession.length === 0) {
                showToast("Add exercises first!");
                return;
            }
            if (!confirm("Finish and save workout?")) return;

            const record = {
                id: uuidv4(),
                date: new Date().toISOString(),
                profile: state.profile,
                exercises: [...state.currentSession]
            };

            state.history.push(record);
            state.currentSession = [];
            saveState();
            render();
            showToast("Workout Saved Successfully!");
        }

        function exportHistory() {
            const json = JSON.stringify(state.history, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                showToast("History copied to clipboard!");
            });
        }

        function setProfile(p) {
            state.profile = p;
            saveState();
            render();
        }

        function toggleHistoryView() {
            state.isHistoryView = !state.isHistoryView;
            saveState(); // Optional: persist view state? Let's just persist data.
            render();
        }

        // --- UI COMPONENTS ---

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const messageEl = document.getElementById('toast-message');
            messageEl.textContent = msg;
            container.classList.remove('opacity-0');
            setTimeout(() => {
                container.classList.add('opacity-0');
            }, 3000);
        }

        // Stepper HTML Generator
        function renderStepper(exerciseId, setId, field, value, step, label) {
            return `
                <div class="flex flex-col items-center">
                    <span class="text-[10px] text-muted font-bold mb-1 uppercase tracking-wider">${label}</span>
                    <div class="flex items-center bg-background rounded-lg p-1 border border-neutral-800">
                        <button class="stepper-btn w-10 h-10 flex items-center justify-center bg-surface hover:bg-neutral-800 active:bg-neutral-700 text-primary rounded" 
                            onclick="handleStepper('${exerciseId}', '${setId}', '${field}', ${value - step})">
                            ${ICONS.minus}
                        </button>
                        
                        <div class="w-16 text-center font-bold text-lg text-white tabular-nums">
                            ${value}
                        </div>

                        <button class="stepper-btn w-10 h-10 flex items-center justify-center bg-surface hover:bg-neutral-800 active:bg-neutral-700 text-primary rounded"
                            onclick="handleStepper('${exerciseId}', '${setId}', '${field}', ${value + step})">
                            ${ICONS.plus}
                        </button>
                    </div>
                </div>
            `;
        }

        // Global handler for stepper clicks to avoid losing context
        window.handleStepper = function(exId, setId, field, val) {
            // Rounding to fix float errors
            val = Math.round(val * 100) / 100;
            if (val < 0) val = 0;
            updateSet(exId, setId, field, val);
        };

        // Date Formatter
        function formatDate(isoString) {
            const d = new Date(isoString);
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        }

        // --- RENDER ENGINE ---

        function render() {
            const root = document.getElementById('app-root');
            const profileContainer = document.getElementById('profile-toggles');
            const historyBtn = document.getElementById('history-toggle');

            // 1. Render Header Toggles
            if (!state.isHistoryView) {
                profileContainer.innerHTML = ['A', 'B'].map(p => `
                    <button onclick="setProfile('${p}')" 
                        class="px-4 py-1.5 rounded-md text-sm font-bold transition-all ${state.profile === p ? 'bg-neutral-700 text-white shadow-sm' : 'text-neutral-500 hover:text-neutral-300'}">
                        ${p}
                    </button>
                `).join('');
                profileContainer.style.display = 'flex';
                historyBtn.classList.remove('text-primary', 'bg-primary/10');
                historyBtn.classList.add('text-neutral-400');
            } else {
                profileContainer.style.display = 'none';
                historyBtn.classList.add('text-primary', 'bg-primary/10');
                historyBtn.classList.remove('text-neutral-400');
            }

            // 2. Render Main Content
            if (state.isHistoryView) {
                renderHistory(root);
            } else {
                renderWorkout(root);
            }
        }

        function renderWorkout(root) {
            let html = `
                <!-- Sticky Dropdown -->
                <div class="sticky top-[61px] z-40 bg-background/95 backdrop-blur border-b border-neutral-800 py-3 px-4">
                    <div class="relative">
                        <select onchange="if(this.value){ addExercise(this.value); this.value=''; }" 
                            class="w-full appearance-none bg-surface border border-neutral-700 hover:border-primary text-white py-3.5 px-4 pr-10 rounded-xl text-base font-medium focus:outline-none focus:border-primary transition-colors cursor-pointer">
                            <option value="" disabled selected class="text-muted">Add Exercise...</option>
                            ${EXERCISE_LISTS[state.profile].map(name => `<option value="${name}" class="text-black bg-white">${name}</option>`).join('')}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-neutral-400">
                            ${ICONS.chevron}
                        </div>
                    </div>
                </div>

                <div class="px-4 space-y-4 pt-4 pb-32">
            `;

            if (state.currentSession.length === 0) {
                html += `
                    <div class="flex flex-col items-center justify-center py-12 text-muted animate-fade-in">
                        <div class="w-16 h-16 bg-surface rounded-full flex items-center justify-center mb-4 text-neutral-600">
                            ${ICONS.plusLarge}
                        </div>
                        <p>Select an exercise above to start</p>
                    </div>
                `;
            } else {
                state.currentSession.forEach(ex => {
                    html += `
                        <div class="bg-surface rounded-2xl p-4 shadow-lg border border-neutral-800 animate-fade-in">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold text-white w-4/5 leading-tight">${ex.name}</h3>
                                <button onclick="removeExercise('${ex.id}')" class="p-2 text-neutral-500 hover:text-danger transition-colors">
                                    ${ICONS.trash}
                                </button>
                            </div>

                            <div class="space-y-3">
                                ${ex.sets.map((set, index) => `
                                    <div class="flex items-center justify-between bg-background/50 p-2 rounded-xl border ${set.completed ? 'border-green-900/50 bg-green-900/10' : 'border-transparent'}">
                                        <div class="text-sm text-neutral-500 w-6 font-mono font-bold">#${index + 1}</div>
                                        
                                        <div class="flex space-x-3">
                                            ${renderStepper(ex.id, set.id, 'weight', set.weight, 2.5, 'LBS')}
                                            ${renderStepper(ex.id, set.id, 'reps', set.reps, 1, 'REPS')}
                                        </div>

                                        <div class="pl-2">
                                            <button onclick="toggleSetComplete('${ex.id}', '${set.id}')" 
                                                class="w-12 h-12 rounded-xl flex items-center justify-center transition-all active:scale-95 ${set.completed ? 'bg-green-600 text-white shadow-lg shadow-green-900/20' : 'bg-neutral-800 text-neutral-500'}">
                                                ${ICONS.check}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <button onclick="addSet('${ex.id}')" class="w-full mt-4 py-3 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-primary font-medium text-sm flex items-center justify-center space-x-2 active:scale-[0.98] transition-all">
                                ${ICONS.plus}
                                <span>Add Set</span>
                            </button>
                        </div>
                    `;
                });
            }

            html += `</div>`; // Close container

            // Finish Button
            if (state.currentSession.length > 0) {
                html += `
                    <div class="fixed bottom-6 left-4 right-4 z-50 animate-slide-up">
                        <button onclick="finishWorkout()" 
                            class="w-full bg-primary text-black font-bold text-lg py-4 rounded-2xl shadow-xl shadow-primary/20 active:scale-[0.98] transition-transform flex items-center justify-center space-x-2">
                            ${ICONS.save}
                            <span>Finish Workout</span>
                        </button>
                    </div>
                `;
            }

            root.innerHTML = html;
        }

        function renderHistory(root) {
            let html = `
                <div class="px-4 py-4 space-y-4 pb-24">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-bold text-white">History</h2>
                        <button onclick="exportHistory()" class="flex items-center space-x-2 px-3 py-2 bg-surface rounded-lg text-primary text-sm font-medium active:scale-95 transition-transform">
                            ${ICONS.copy}
                            <span>Export JSON</span>
                        </button>
                    </div>
            `;

            if (state.history.length === 0) {
                html += `<div class="text-center text-muted py-12">No workouts recorded yet.</div>`;
            } else {
                // Clone and reverse for display
                [...state.history].reverse().forEach(record => {
                    html += `
                        <div class="bg-surface rounded-xl p-4 border border-neutral-800 shadow-sm">
                            <div class="flex justify-between items-start mb-3 border-b border-neutral-800 pb-2">
                                <div>
                                    <div class="text-lg font-bold text-white">Workout ${record.profile}</div>
                                    <div class="text-xs text-muted">${formatDate(record.date)}</div>
                                </div>
                                <div class="text-xs font-mono bg-neutral-900 px-2 py-1 rounded text-neutral-400 h-fit">
                                    ${record.exercises.length} Exercises
                                </div>
                            </div>
                            <div class="space-y-2">
                                ${record.exercises.map(ex => {
                                    // Find best set (heaviest)
                                    const bestSet = ex.sets.reduce((prev, current) => (prev.weight > current.weight ? prev : current), ex.sets[0]);
                                    return `
                                        <div class="flex justify-between text-sm">
                                            <span class="text-neutral-300 truncate w-2/3">${ex.name}</span>
                                            <span class="text-primary font-medium">
                                                ${bestSet ? `${bestSet.weight}lbs x ${bestSet.reps}` : '-'}
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            root.innerHTML = html;
        }

        // --- INITIALIZATION ---
        document.getElementById('history-toggle').addEventListener('click', toggleHistoryView);
        
        // Load data and start
        loadState();

    </script>
</body>
</html>
